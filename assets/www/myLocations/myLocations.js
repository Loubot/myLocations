// Generated by CoffeeScript 1.6.3
(function() {
  var ajax, saveOffersAndAttractions;

  window.init = function() {
    var latlng, myLocsInfo;
    $.mobile.loading('show', {
      text: 'Please wait',
      textVisible: true,
      theme: 'a'
    });
    myLocsInfo = (function() {
      function myLocsInfo() {
        this.offersInfo = [];
        this.attrsInfo = [];
        this.attrsMarkers = new Array();
        this.offersMarkers = new Array();
      }

      myLocsInfo.prototype.setAttrsInfo = function(key, offer) {
        return this.attrsInfo[key] = offer;
      };

      myLocsInfo.prototype.setOffersInfo = function(key, offer) {
        return this.offersInfo[key] = offer;
      };

      myLocsInfo.prototype.setAttrsMarkers = function(marker) {
        return this.attrsMarkers.push(marker);
      };

      myLocsInfo.prototype.setOffersMarkers = function(marker) {
        return this.offersMarkers.push(marker);
      };

      myLocsInfo.prototype.getAttrsInfo = function(key) {
        return this.attrsInfo[key];
      };

      myLocsInfo.prototype.getOffersInfo = function(key) {
        return this.offersInfo[key];
      };

      myLocsInfo.prototype.displayAttrs = function() {
        var marker, _i, _len, _ref, _results;
        this.clearOffersMarkers();
        _ref = this.attrsMarkers;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          marker = _ref[_i];
          _results.push(marker.setMap(map));
        }
        return _results;
      };

      myLocsInfo.prototype.displayOffers = function() {
        var marker, _i, _len, _ref, _results;
        this.clearAttrsMarkers();
        _ref = this.offersMarkers;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          marker = _ref[_i];
          _results.push(marker.setMap(map));
        }
        return _results;
      };

      myLocsInfo.prototype.displayAll = function() {
        var marker, _i, _j, _len, _len1, _ref, _ref1, _results;
        _ref = this.attrsMarkers;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          marker = _ref[_i];
          marker.setMap(map);
        }
        _ref1 = this.offersMarkers;
        _results = [];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          marker = _ref1[_j];
          _results.push(marker.setMap(map));
        }
        return _results;
      };

      myLocsInfo.prototype.clearAttrsMarkers = function() {
        var marker, _i, _len, _ref, _results;
        _ref = this.attrsMarkers;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          marker = _ref[_i];
          _results.push(marker.setMap(null));
        }
        return _results;
      };

      myLocsInfo.prototype.clearOffersMarkers = function() {
        var marker, _i, _len, _ref, _results;
        _ref = this.offersMarkers;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          marker = _ref[_i];
          _results.push(marker.setMap(null));
        }
        return _results;
      };

      return myLocsInfo;

    })();
    window.myLocationInfo = new myLocsInfo();
    latlng = new google.maps.LatLng(51.850731, -8.301129);
    window.map = new google.maps.Map(document.getElementById('mapDiv'), {
      zoom: 11,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    return ajax.init();
  };

  ajax = {
    init: function() {
      var adsAjax, attractionsAjax;
      attractionsAjax = {
        getAttrs: function() {
          var promise;
          promise = $.Deferred();
          $.ajax('#', {
            data: {
              lat: 51.850731,
              lon: -8.301129
            },
            type: 'POST',
            dataType: 'json',
            timeout: 100000,
            success: function(json) {
              return promise.resolve(json.result);
            },
            error: function(error) {
              return promise.reject(error);
            }
          });
          return promise;
        }
      };
      adsAjax = {
        getOffers: function() {
          var adsPromise;
          adsPromise = $.Deferred();
          $.ajax('#', {
            data: {
              lat: 51.850731,
              lon: -8.301129
            },
            type: 'POST',
            dataType: 'json',
            timeout: 100000,
            success: function(json) {
              return adsPromise.resolve(json.result);
            },
            error: function(error) {
              return adsPromise.reject(error);
            }
          });
          return adsPromise;
        }
      };
      return $.when(attractionsAjax.getAttrs(), adsAjax.getOffers()).then(function(getAttrsResult, getOffersResult) {
        console.log('Got attractions');
        console.log('Got Offers');
        return saveOffersAndAttractions(getAttrsResult, getOffersResult);
      }).fail(function(attrsError, offersError) {
        console.log('attrs Failed' + JSON.stringify(attrsError));
        return console.log('offers failed' + JSON.stringify(offersError));
      });
    }
  };

  saveOffersAndAttractions = function(getAttrsResult, getOffersResult) {
    window.infowindow = new google.maps.InfoWindow({
      content: ""
    });
    $(getAttrsResult).each(function() {
      var latlng, marker;
      myLocationInfo.setAttrsInfo(this.id, this);
      if (typeof infowindow !== "undefined" && infowindow !== null) {
        latlng = new google.maps.LatLng(this.lat, this.lon);
        marker = new google.maps.Marker({
          position: latlng,
          icon: 'http://maps.google.com/mapfiles/marker_purple.png',
          map: null
        });
        marker['infowindow'] = "<div id = \"content\" class=\"attrsInfo\"><a href = '#' onclick = \"changePage('attr','" + this.id + "')\" id = " + this.id + ">" + this.name + "</a></div>";
        myLocationInfo.setAttrsMarkers(marker);
        return google.maps.event.addListener(marker, 'click', function() {
          infowindow.setContent(this['infowindow']);
          return infowindow.open(map, this);
        });
      }
    });
    $(getOffersResult).each(function() {
      var latlng, marker;
      myLocationInfo.setOffersInfo(this.id, this);
      if (typeof infowindow !== "undefined" && infowindow !== null) {
        latlng = new google.maps.LatLng(this.lat, this.lon);
        marker = new google.maps.Marker({
          position: latlng,
          icon: 'http://maps.google.com/mapfiles/marker_green.png',
          map: null
        });
        marker['infowindow'] = "<div id=\"content\" class=\"offersInfo\"><a href = '#' onclick = \"changePage('offer', '" + this.id + "')\" id=" + this.id + ">" + this.advertiser + "</a></div>";
        myLocationInfo.setOffersMarkers(marker);
        return google.maps.event.addListener(marker, 'click', function() {
          infowindow.setContent(this['infowindow']);
          return infowindow.open(map, this);
        });
      }
    });
    myLocationInfo.displayAttrs();
    return $.mobile.loading('hide');
  };

  window.displayOffers = function() {
    return myLocationInfo.displayOffers();
  };

  window.displayAttrs = function() {
    return myLocationInfo.displayAttrs();
  };

  window.displayAll = function() {
    return myLocationInfo.displayAll();
  };

  window.changePage = function(type, id) {
    switch (type) {
      case 'attr':
        $.mobile.showPageLoadingMsg("a", "Please wait");
        window.sessionStorage.setItem('mapInfo', JSON.stringify(myLocationInfo.getAttrsInfo(id)));
        window.localStorage.setItem('positionLat', '51.850731');
        window.localStorage.setItem('positionLon', '-8.301129');
        return $.mobile.changePage('../mapPage/mapPage.html', {
          transition: 'pop',
          reverse: false,
          changeHash: true
        });
      case 'offer':
        alert(JSON.stringify(myLocationInfo.getOffersInfo(id)));
        return window.localStorage.setItem("displayOfferInfo", JSON.stringify(myLocationInfo.getOffersInfo(id)));
    }
  };

}).call(this);
